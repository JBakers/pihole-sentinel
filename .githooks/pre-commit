#!/bin/bash
#
# Pre-commit hook to enforce version management rules
# This hook ensures VERSION and CHANGELOG.md are updated with every commit
#
# INSTALLATION:
# cp .githooks/pre-commit .git/hooks/pre-commit
# chmod +x .git/hooks/pre-commit
#
# OR use git config:
# git config core.hooksPath .githooks
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit version check...${NC}"

# Check if this is an initial commit
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
else
    # Initial commit: diff against an empty tree object
    against=$(git hash-object -t tree /dev/null)
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any code files are being committed (exclude docs-only changes)
CODE_CHANGED=false
for file in $STAGED_FILES; do
    # Check if file is a code file (not just documentation)
    if [[ "$file" =~ \.(py|sh|conf|service|timer)$ ]] && \
       [[ ! "$file" =~ ^(CHANGELOG\.md|VERSION|.*\.md|LICENSE)$ ]]; then
        CODE_CHANGED=true
        break
    fi
done

# If only documentation changed, allow commit without version update
if [ "$CODE_CHANGED" = false ]; then
    echo -e "${GREEN}✓ Documentation-only change detected, skipping version check${NC}"
    exit 0
fi

# Check if VERSION file was modified
VERSION_MODIFIED=false
if echo "$STAGED_FILES" | grep -q "^VERSION$"; then
    VERSION_MODIFIED=true
fi

# Check if CHANGELOG.md was modified
CHANGELOG_MODIFIED=false
if echo "$STAGED_FILES" | grep -q "^CHANGELOG\.md$"; then
    CHANGELOG_MODIFIED=true
fi

# Enforce version update rules
ERRORS=0

if [ "$VERSION_MODIFIED" = false ]; then
    echo -e "${RED}✗ ERROR: VERSION file not updated!${NC}"
    echo -e "${YELLOW}  Please update the VERSION file before committing code changes.${NC}"
    ERRORS=$((ERRORS + 1))
fi

if [ "$CHANGELOG_MODIFIED" = false ]; then
    echo -e "${RED}✗ ERROR: CHANGELOG.md not updated!${NC}"
    echo -e "${YELLOW}  Please add an entry to CHANGELOG.md before committing code changes.${NC}"
    ERRORS=$((ERRORS + 1))
fi

# Additional quality checks
echo -e "${YELLOW}Running code quality checks...${NC}"

# Check for print() statements in Python files (excluding setup.py)
for file in $STAGED_FILES; do
    if [[ "$file" =~ \.py$ ]] && [[ "$file" != "setup.py" ]]; then
        if grep -q "print(" "$file"; then
            echo -e "${RED}✗ ERROR: print() statement found in $file${NC}"
            echo -e "${YELLOW}  Use logger.*() instead of print() in production code${NC}"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Check for CRLF line endings in bash scripts
for file in $STAGED_FILES; do
    if [[ "$file" =~ \.sh$ ]]; then
        if file "$file" | grep -q "CRLF"; then
            echo -e "${RED}✗ ERROR: CRLF line endings detected in $file${NC}"
            echo -e "${YELLOW}  Use LF line endings (Unix style) for bash scripts${NC}"
            echo -e "${YELLOW}  Fix with: sed -i 's/\r$//' $file${NC}"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Exit with error if any checks failed
if [ $ERRORS -gt 0 ]; then
    echo ""
    echo -e "${RED}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${RED}  PRE-COMMIT HOOK FAILED - $ERRORS error(s) found${NC}"
    echo -e "${RED}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Required actions:${NC}"
    [ "$VERSION_MODIFIED" = false ] && echo -e "  1. Update VERSION file with new semantic version"
    [ "$CHANGELOG_MODIFIED" = false ] && echo -e "  2. Add entry to CHANGELOG.md under new version"
    echo ""
    echo -e "${YELLOW}To bypass this check (NOT RECOMMENDED):${NC}"
    echo -e "  git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}✓ All pre-commit checks passed!${NC}"
exit 0
