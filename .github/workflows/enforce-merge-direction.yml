name: Enforce Merge Direction

# This workflow prevents merges in the wrong direction
# Allowed: features ‚Üí develop ‚Üí testing ‚Üí main
# Blocked: main ‚Üí testing, testing ‚Üí develop, develop ‚Üí features

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-merge-direction:
    runs-on: ubuntu-latest
    name: Check PR Merge Direction

    steps:
      - name: Check merge direction
        id: check
        env:
          BASE_BRANCH: ${{ github.base_ref }}
          HEAD_BRANCH: ${{ github.head_ref }}
        run: |
          echo "Base branch (merge target): $BASE_BRANCH"
          echo "Head branch (source): $HEAD_BRANCH"

          # Define allowed merge patterns
          # Format: "source->target"

          BLOCKED=false
          REASON=""

          # Block: testing ‚Üí develop
          if [[ "$BASE_BRANCH" == "develop" ]] && [[ "$HEAD_BRANCH" == "testing" ]]; then
            BLOCKED=true
            REASON="‚ùå BLOCKED: Cannot merge testing ‚Üí develop (wrong direction!)"
          fi

          # Block: main ‚Üí testing
          if [[ "$BASE_BRANCH" == "testing" ]] && [[ "$HEAD_BRANCH" == "main" ]]; then
            BLOCKED=true
            REASON="‚ùå BLOCKED: Cannot merge main ‚Üí testing (wrong direction!)"
          fi

          # Block: main ‚Üí develop
          if [[ "$BASE_BRANCH" == "develop" ]] && [[ "$HEAD_BRANCH" == "main" ]]; then
            BLOCKED=true
            REASON="‚ùå BLOCKED: Cannot merge main ‚Üí develop (wrong direction!)"
          fi

          # Block: testing ‚Üí features (any feature branch)
          if [[ "$HEAD_BRANCH" == "testing" ]] && [[ "$BASE_BRANCH" =~ ^(feature|fix|chore|docs)/ ]]; then
            BLOCKED=true
            REASON="‚ùå BLOCKED: Cannot merge testing ‚Üí feature branch (wrong direction!)"
          fi

          # Block: develop ‚Üí features (any feature branch)
          if [[ "$HEAD_BRANCH" == "develop" ]] && [[ "$BASE_BRANCH" =~ ^(feature|fix|chore|docs)/ ]]; then
            BLOCKED=true
            REASON="‚ùå BLOCKED: Cannot merge develop ‚Üí feature branch (wrong direction!)"
          fi

          # Check if blocked
          if [[ "$BLOCKED" == "true" ]]; then
            echo "::error::$REASON"
            echo ""
            echo "‚úÖ ALLOWED merge directions:"
            echo "   ‚Ä¢ feature/* ‚Üí develop"
            echo "   ‚Ä¢ develop ‚Üí testing"
            echo "   ‚Ä¢ testing ‚Üí main"
            echo ""
            echo "‚ùå Your PR: $HEAD_BRANCH ‚Üí $BASE_BRANCH"
            echo ""
            echo "Please close this PR and create one in the correct direction."
            exit 1
          fi

          # If we reach here, merge direction is allowed
          echo "‚úÖ Merge direction is ALLOWED: $HEAD_BRANCH ‚Üí $BASE_BRANCH"

          # Provide helpful info about the merge
          if [[ "$BASE_BRANCH" == "develop" ]]; then
            echo "üìù Merging to develop - this is the integration branch"
          elif [[ "$BASE_BRANCH" == "testing" ]]; then
            echo "üß™ Merging to testing - ensure all changes are tested thoroughly"
          elif [[ "$BASE_BRANCH" == "main" ]]; then
            echo "üöÄ Merging to main - this will be a production release!"
          fi

      - name: Add merge direction comment
        if: success()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const baseRef = context.payload.pull_request.base.ref;
            const headRef = context.payload.pull_request.head.ref;

            let emoji = '‚úÖ';
            let message = '';

            if (baseRef === 'main') {
              emoji = 'üöÄ';
              message = '**Production Release**\n\nThis PR will merge to `main` - ensure all testing is complete!';
            } else if (baseRef === 'testing') {
              emoji = 'üß™';
              message = '**Testing Branch**\n\nThis PR will merge to `testing` - ready for QA validation.';
            } else if (baseRef === 'develop') {
              emoji = 'üìù';
              message = '**Development Branch**\n\nThis PR will merge to `develop` - integration and development testing.';
            }

            const comment = emoji + ' **Merge Direction Check: PASSED**\n\n' +
              message + '\n\n' +
              '**Merge flow:** `' + headRef + '` ‚Üí `' + baseRef + '`\n\n' +
              '<details>\n' +
              '<summary>‚ÑπÔ∏è Allowed merge directions</summary>\n\n' +
              '- ‚úÖ `feature/*` ‚Üí `develop`\n' +
              '- ‚úÖ `develop` ‚Üí `testing`\n' +
              '- ‚úÖ `testing` ‚Üí `main`\n' +
              '- ‚ùå Reverse merges are blocked\n\n' +
              '</details>';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
